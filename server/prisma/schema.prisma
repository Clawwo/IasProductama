generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(PETUGAS)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions  Session[]
  inboundCreated      Inbound[]              @relation("InboundCreatedBy")
  outboundCreated     Outbound[]             @relation("OutboundCreatedBy")
  productionCreated   Production[]           @relation("ProductionCreatedBy")
  draftCreated        Draft[]                @relation("DraftCreatedBy")
  draftUpdated        Draft[]                @relation("DraftUpdatedBy")
  rawOutboundCreated  RawMaterialOutbound[]  @relation("RawOutboundCreatedBy")
}

model Session {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenHash String
  userAgent        String?
  ipAddress        String?
  createdAt        DateTime  @default(now())
  expiresAt        DateTime
  revokedAt        DateTime?

  @@index([userId])
}

model Inbound {
  id        String        @id @default(uuid())
  code      String        @unique
  vendor    String
  date      DateTime
  note      String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  createdById String?
  createdBy   User?        @relation("InboundCreatedBy", fields: [createdById], references: [id])
  lines     InboundLine[]

  @@index([createdById])
}

model InboundLine {
  id        String  @id @default(uuid())
  inboundId String
  code      String
  qty       Int
  note      String?
  inbound   Inbound @relation(fields: [inboundId], references: [id], onDelete: Cascade)

  @@index([inboundId])
}

model Outbound {
  id        String         @id @default(uuid())
  code      String         @unique
  orderer   String
  date      DateTime
  note      String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  createdById String?
  createdBy   User?         @relation("OutboundCreatedBy", fields: [createdById], references: [id])
  lines     OutboundLine[]

  @@index([createdById])
}

model OutboundLine {
  id         String   @id @default(uuid())
  outboundId String
  code       String
  qty        Int
  note       String?
  outbound   Outbound @relation(fields: [outboundId], references: [id], onDelete: Cascade)

  @@index([outboundId])
}

model Item {
  code        String   @id
  name        String?
  category    String?
  subCategory String?
  kind        String?
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

model BahanBaku {
  code      String   @id
  name      String?
  category  String?
  subCategory String?
  kind      String?
  stock     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  outboundLines RawMaterialOutboundLine[]
}

model Bom {
  id          String    @id @default(uuid())
  productCode String    @unique
  productName String?
  category    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  lines       BomLine[]
}

model BomLine {
  id         String        @id @default(uuid())
  bomId      String
  sourceType BomSourceType @default(BAHAN_BAKU)
  code       String?
  name       String?
  qty        Float
  bom        Bom           @relation(fields: [bomId], references: [id], onDelete: Cascade)

  @@index([bomId])
}

model Production {
  id             String                  @id @default(uuid())
  code           String                  @unique
  date           DateTime
  note           String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  createdById    String?
  createdBy      User?                   @relation("ProductionCreatedBy", fields: [createdById], references: [id])
  rawLines       ProductionRawLine[]
  finishedLines  ProductionFinishedLine[]

  @@index([createdById])
}

model ProductionRawLine {
  id            String      @id @default(uuid())
  productionId  String
  code          String
  name          String?
  category      String?
  subCategory   String?
  kind          String?
  qty           Int
  note          String?
  sourceType    BomSourceType @default(BAHAN_BAKU)
  production    Production @relation(fields: [productionId], references: [id], onDelete: Cascade)

  @@index([productionId])
}

model ProductionFinishedLine {
  id            String      @id @default(uuid())
  productionId  String
  code          String
  name          String?
  category      String?
  subCategory   String?
  kind          String?
  qty           Int
  note          String?
  production    Production @relation(fields: [productionId], references: [id], onDelete: Cascade)

  @@index([productionId])
}

model Product {
  code        String   @id
  name        String
  category    String
  subCategory String?
  size        String?
  color       String?
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

model Draft {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      DraftType
  payload   Json
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  createdById String?
  createdBy   User?   @relation("DraftCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("DraftUpdatedBy", fields: [updatedById], references: [id])

  @@index([createdById])
  @@index([updatedById])
}

model RawMaterialOutbound {
  id         String                     @id @default(uuid())
  code       String                     @unique
  artisan    String
  date       DateTime
  note       String?
  status     RawMaterialOutboundStatus  @default(OUT)
  receivedAt DateTime?
  createdAt  DateTime                   @default(now())
  updatedAt  DateTime                   @updatedAt
  createdById String?
  createdBy   User?                      @relation("RawOutboundCreatedBy", fields: [createdById], references: [id])
  lines      RawMaterialOutboundLine[]

  @@index([createdById])
}

model RawMaterialOutboundLine {
  id            String                     @id @default(uuid())
  outboundId    String
  materialCode  String
  materialName  String?
  category      String?
  subCategory   String?
  kind          String?
  batchCode     String
  qty           Int
  note          String?
  status        RawMaterialOutboundStatus  @default(OUT)
  receivedAt    DateTime?
  receivedBy    String?
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  outbound      RawMaterialOutbound        @relation(fields: [outboundId], references: [id], onDelete: Cascade)
  material      BahanBaku                  @relation(fields: [materialCode], references: [code])

  @@index([outboundId])
  @@index([materialCode])
  @@index([batchCode])
}

enum Role {
  ADMIN
  PETUGAS
  PELIHAT
}

enum DraftType {
  INBOUND
  OUTBOUND
  PRODUCTION
}

enum BomSourceType {
  ITEM
  BAHAN_BAKU
}

enum RawMaterialOutboundStatus {
  OUT
  RECEIVED
}
